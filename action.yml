name: 'Helm Cleanup'
author: DevOps
description: Run repository helm cleanup

inputs:
  namespace:
    description: 'Helm Namespace'
    required: true
  aws-access-key-id:
    description: 'AWS Access Key ID'
    required: true
  aws-secret-access-key:
    description: 'AWS Secret Access Key'
    required: true
    
runs:
  using: 'composite'
  steps:
    - name: Authenticate with DEV
      uses: aws-actions/configure-aws-credentials@v1-node16
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: us-east-1
      shell: bash
          
    - name: Clean Up Helm
      id: helm-uninstall
      run: |
        namespace="${{ inputs.namespace }}"
        results_array=$(kubectl get pods  --no-headers -o custom-columns=":metadata.name" -n $namespace)
        pods=(`echo ${results_array}`);

        for i in "${pods[@]}"
        do
          value=$(kubectl get pods $i --no-headers -n $namespace)
          if [[ ${value} != *"Running"* ]] && [[ ${value} != *"Terminating"* ]]; then
                # helm name is retrieved by excluding everything after second to last dash:
                echo "POD STATUS: ${value}"
                HELM_NAME=$(echo $i | sed 's/\-[^-]*$//' | sed 's/\-[^-]*$//')
                echo "Uninstall HELM: ${HELM_NAME}"
                helm uninstall $HELM_NAME -n $namespace
          fi
        done
      shell: bash